<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <base href="/">
  <title>Editar Perfil - Jobly</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/auth.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .label-small { color: #141514; font-weight:600; font-size:14px }
    .muted { color: #767977 }
  </style>
</head>
<body class="bg-[#fbfcfb] min-h-screen font-[Poppins,sans-serif] overflow-x-hidden">
  <!-- Header -->
  <header class="flex items-center justify-between px-[32px] pl-[32px] pr-[108px] pt-[24px] pb-[16px] border-b border-[#e5eae8] h-[86px] bg-white">
    <a href="/home-postulantes" class="block h-[62px] w-[172px]">
      <img src="/static/images/logo-login.png" alt="Jobly Logo" class="h-full w-full object-contain" />
    </a>
    <div class="flex-1"></div>
    <div class="flex items-center gap-6">
      <!-- Bell -->
      <img src="https://www.figma.com/api/mcp/asset/6d7764a6-07de-48fc-af3e-a858d0974bb7" alt="bell" class="w-6 h-6" />
      <!-- Profile circle -->
      <img src="https://www.figma.com/api/mcp/asset/9f99fd2a-ab50-41e4-825c-68a884b37b10" alt="profile" class="w-6 h-6 rounded-full" />
      <button id="logoutBtn" class="border border-[#141514] text-[#141514] px-3 py-1 rounded-[24px] text-sm font-semibold hover:bg-[#141514] hover:text-white transition-colors">Cerrar sesión</button>
    </div>
  </header>

  <!-- Subheader eliminado -->

  <!-- Main Card -->
  <main class="max-w-[1000px] mx-auto px-4 pt-12 pb-24">
    <div class="bg-white border border-[#cfd4d1] rounded-[4px] p-[40px] mt-8">
      <!-- Header row with avatar and account info -->
      <div class="flex items-start gap-6">
        <div class="w-[136px] h-[136px] rounded-[68px] border border-[#e5eae8] overflow-hidden relative flex items-center justify-center bg-white">
          <img id="avatarImg" alt="avatar" class="w-full h-full object-cover hidden" />
          <!-- Silueta SVG -->
          <svg id="avatarPlaceholder" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-24 h-24 text-[#cfd4d1]">
            <circle cx="12" cy="8" r="5" fill="#cfd4d1" />
            <path d="M2 22c0-5.523 4.477-10 10-10s10 4.477 10 10" fill="#cfd4d1" />
          </svg>
          <button id="editAvatar" class="absolute bottom-2 right-2 bg-white border border-[#e5eae8] rounded-full p-2" title="Subir foto">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4 text-[#141514]">
              <path fill="currentColor" d="M12 5v14m-7-7h14" stroke="#141514" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <input type="file" id="avatarFile" accept="image/*" class="hidden" />
        </div>
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <div>
              <h1 id="nombreHeading" class="text-[32px] font-semibold text-[#141514]">Mi Perfil</h1>
              <p id="cuentaInfo" class="muted">Cargando cuenta...</p>
            </div>
            <div>
              <button id="openToBtn" class="border border-[#13060e] px-6 py-2 rounded-[64px] text-[16px] font-semibold">Open to</button>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-8 border-[#e5eae8]" />

      <!-- Editable Profile Form -->
      <form id="perfilForm" class="grid grid-cols-2 gap-6">
        <div class="col-span-2">
          <label class="label-small" for="nombreInput">Nombre completo</label>
          <input id="nombreInput" type="text" class="w-full border border-[#cfd4d1] rounded-[4px] p-3 text-[14px]" placeholder="Tu nombre" />
        </div>
        <div>
          <label class="label-small" for="fechaInput">Fecha de nacimiento</label>
          <input id="fechaInput" type="date" class="w-full border border-[#cfd4d1] rounded-[4px] p-3 text-[14px]" />
        </div>
        <div>
          <label class="label-small" for="generoInput">Género</label>
          <select id="generoInput" class="w-full border border-[#cfd4d1] rounded-[4px] p-3 text-[14px]">
            <option value="">Selecciona...</option>
            <option value="Femenino">Femenino</option>
            <option value="Masculino">Masculino</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div>
          <label class="label-small" for="linkedinInput">LinkedIn</label>
          <input id="linkedinInput" type="url" class="w-full border border-[#cfd4d1] rounded-[4px] p-3 text-[14px]" placeholder="https://www.linkedin.com/in/usuario" />
        </div>
        <div>
          <label class="label-small" for="githubInput">GitHub</label>
          <input id="githubInput" type="url" class="w-full border border-[#cfd4d1] rounded-[4px] p-3 text-[14px]" placeholder="https://github.com/usuario" />
        </div>
        <div class="col-span-2">
          <label class="label-small" for="portafolioInput">Portafolio</label>
          <input id="portafolioInput" type="url" class="w-full border border-[#cfd4d1] rounded-[4px] p-3 text-[14px]" placeholder="https://mi-sitio.com" />
        </div>

        <div class="col-span-2 mt-2">
          <button type="submit" class="bg-[#c89bfa] text-white px-6 py-3 rounded-[64px] text-[16px] font-semibold hover:bg-[#b080e8]">Guardar cambios</button>
          <span id="saveStatus" class="ml-3 text-[#606261]"></span>
        </div>
      </form>

      <hr class="my-8 border-[#e5eae8]" />

      <section>
        <h2 class="text-[24px] font-semibold text-[#8c8f8e] mb-4">Currículum</h2>
        <div class="bg-white border border-[#e5eae8] p-6 rounded-[4px] flex items-center justify-between">
          <div class="flex items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6 text-[#606261]"><path fill="currentColor" d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.1.9-2 2-2Z"/></svg>
            <div>
              <div id="cvLabel" class="font-semibold text-[16px]">Sin CV</div>
              <div id="cvSub" class="text-[12px] muted">(pendiente de carga)</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="downloadCvBtn" class="hidden border border-[#141514] px-3 py-1 rounded-[24px] text-sm font-semibold" title="Descargar CV">Descargar</button>
            <button id="uploadCvBtn" class="border border-[#141514] px-3 py-1 rounded-[24px] text-sm font-semibold hover:bg-[#141514] hover:text-white transition-colors" title="Subir CV">Subir CV</button>
            <input type="file" id="cvFile" accept="application/pdf" class="hidden" />
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Cargar datos de perfil
      try {
        const res = await fetch('/api/candidato/perfil');
        if (!res.ok) {
          if (res.status === 401) { window.location.href = '/login'; return; }
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || 'No se pudo cargar el perfil');
        }
        const data = await res.json();
        const acc = data.account || {};
        const p = data.profile || {};
        const hasAvatar = !!p.has_avatar;
        const hasCv = !!p.has_cv;

        // Mostrar cuenta
        document.getElementById('cuentaInfo').textContent = `${acc.email || ''} · ${acc.rol || ''}`;
        document.getElementById('nombreHeading').textContent = p.nombre_completo || 'Mi Perfil';

        // Prefill inputs
        document.getElementById('nombreInput').value = p.nombre_completo || '';
        document.getElementById('fechaInput').value = p.fecha_nacimiento || '';
        document.getElementById('generoInput').value = p.genero || '';
        document.getElementById('linkedinInput').value = p.linkedin_url || '';
        document.getElementById('githubInput').value = p.github_url || '';
        document.getElementById('portafolioInput').value = p.portafolio_url || '';
        // Avatar display
        const avatarImg = document.getElementById('avatarImg');
        const avatarPlaceholder = document.getElementById('avatarPlaceholder');
        if (hasAvatar) {
          avatarImg.src = '/api/candidato/avatar?_=' + Date.now(); // evitar cache
          avatarImg.classList.remove('hidden');
          avatarPlaceholder.classList.add('hidden');
        }

        // CV display
        const cvLabel = document.getElementById('cvLabel');
        const cvSub = document.getElementById('cvSub');
        const downloadCvBtn = document.getElementById('downloadCvBtn');
        if (hasCv) {
          cvLabel.textContent = 'Mi CV';
          cvSub.textContent = 'Última versión cargada';
          downloadCvBtn.classList.remove('hidden');
        }
      } catch (e) {
        console.error(e);
        alert(e.message);
      }

      // Guardar cambios
      document.getElementById('perfilForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const payload = {
          nombre_completo: document.getElementById('nombreInput').value.trim() || null,
          fecha_nacimiento: document.getElementById('fechaInput').value || null,
          genero: document.getElementById('generoInput').value || null,
          linkedin_url: document.getElementById('linkedinInput').value.trim() || null,
          github_url: document.getElementById('githubInput').value.trim() || null,
          portafolio_url: document.getElementById('portafolioInput').value.trim() || null,
        };
        // remove nulls not necessary but ok
        Object.keys(payload).forEach(k => payload[k] === null && delete payload[k]);
        const status = document.getElementById('saveStatus');
        status.textContent = 'Guardando...';
        try {
          const resp = await fetch('/api/candidato/perfil', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || 'No se pudo guardar');
          }
          status.textContent = 'Cambios guardados';
          setTimeout(() => status.textContent = '', 2000);
        } catch (err) {
          console.error(err);
          status.textContent = '';
          alert(err.message);
        }
      });

      // Edit avatar placeholder
      // Subida avatar
      const editAvatarBtn = document.getElementById('editAvatar');
      const avatarFileInput = document.getElementById('avatarFile');
      editAvatarBtn?.addEventListener('click', () => avatarFileInput.click());
      avatarFileInput?.addEventListener('change', async () => {
        if (!avatarFileInput.files?.length) return;
        const f = avatarFileInput.files[0];
        const fd = new FormData();
        fd.append('file', f);
        try {
          const resp = await fetch('/api/candidato/avatar', { method: 'POST', body: fd });
          if (!resp.ok) throw new Error('Error subiendo avatar');
          // refrescar avatar
          const avatarImg = document.getElementById('avatarImg');
          const avatarPlaceholder = document.getElementById('avatarPlaceholder');
          avatarImg.src = '/api/candidato/avatar?_=' + Date.now();
          avatarImg.classList.remove('hidden');
          avatarPlaceholder.classList.add('hidden');
        } catch (err) { alert(err.message); }
      });

      // Subida CV
      const uploadCvBtn = document.getElementById('uploadCvBtn');
      const cvFileInput = document.getElementById('cvFile');
      const downloadCvBtn = document.getElementById('downloadCvBtn');
      uploadCvBtn?.addEventListener('click', () => cvFileInput.click());
      cvFileInput?.addEventListener('change', async () => {
        if (!cvFileInput.files?.length) return;
        const f = cvFileInput.files[0];
        if (f.type !== 'application/pdf') { alert('Solo PDF'); return; }
        const fd = new FormData();
        fd.append('file', f);
        try {
          const resp = await fetch('/api/candidato/cv', { method: 'POST', body: fd });
          if (!resp.ok) throw new Error('Error subiendo CV');
          document.getElementById('cvLabel').textContent = 'Mi CV';
          document.getElementById('cvSub').textContent = 'Última versión cargada';
          downloadCvBtn.classList.remove('hidden');
        } catch (err) { alert(err.message); }
      });
      downloadCvBtn?.addEventListener('click', () => {
        window.open('/api/candidato/cv', '_blank');
      });
    });
  </script>
</body>
</html>
