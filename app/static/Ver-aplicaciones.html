<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ver Aplicaciones - Jobly</title>
  <!-- Tailwind via CDN (on-demand) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              100: '#F23E8E',
              shade60: '#892753',
              shade80: '#D93A80',
              tint10: '#FFF0F5',
              tint02: '#FFF9FB',
              shade05: '#13060E'
            },
            neutral: {
              10: '#1D1E1D',
              20: '#333434',
              30: '#4A4B4A',
              40: '#606261',
              50: '#767977',
              60: '#8C8F8E',
              70: '#A2A6A4',
              80: '#B8BDBB'
            },
            link: '#6532C1'
          },
          fontFamily: {
            poppins: ['Poppins','sans-serif'],
            inter: ['Inter','sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    /* Hide scrollbars for job list area (similar to Figma aesthetic) */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="font-poppins bg-white text-neutral-10">
  <!-- Header -->
  <header class="flex items-center justify-between px-[32px] pl-[32px] pr-[108px] pt-[24px] pb-[16px] border-b border-[#e5eae8] h-[86px] bg-white">
    <a href="/home-postulantes" class="block h-[62px] w-[172px]">
      <img src="/static/images/logo-login.png" alt="Jobly Logo" class="h-full w-full object-contain"
           onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27172%27 height=%2762%27%3E%3Crect width=%27172%27 height=%2762%27 fill=%27%23f23e8e%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27white%27 font-family=%27Arial%27 font-size=%2720%27%3EJobly%3C/text%3E%3C/svg%3E'" />
    </a>
    <div class="flex-1"></div>
    <div class="flex items-center gap-6">
      <!-- Help Icon -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="#141514" stroke-width="1.5"/>
        <path d="M9.09 9C9.325 8.33 9.835 7.81 10.5 7.57C11.165 7.33 11.903 7.39 12.516 7.74C13.129 8.09 13.563 8.69 13.72 9.38C13.877 10.07 13.745 10.79 13.35 11.38C12.955 11.97 12.33 12.38 11.62 12.51V13.5" stroke="#141514" stroke-linecap="round"/>
        <circle cx="12" cy="17" r="1" fill="#141514"/>
      </svg>
      <!-- Mail Icon -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="#141514" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M22 6L12 13L2 6" stroke="#141514" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <!-- Profile Icon -->
      <button id="profileBtn" aria-label="Perfil" class="w-6 h-6">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#c89bfa"/>
          <circle cx="12" cy="10" r="3" fill="white"/>
          <path d="M6.168 18.849A6.5 6.5 0 0 1 12 15.5a6.5 6.5 0 0 1 5.832 3.349" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
      <!-- Logout Button -->
      <button id="logoutBtn" class="border border-[#141514] text-[#141514] px-3 py-1 rounded-[24px] text-sm font-semibold hover:bg-[#141514] hover:text-white transition-colors">Cerrar sesión</button>
    </div>
  </header>

  <!-- Subheader Tabs -->
  <nav class="flex gap-[64px] items-end justify-center px-[108px] pt-[16px] pb-0 border-b border-[#e5eae8] h-[56px] bg-white relative">
    <div class="flex flex-col gap-[14px] items-center justify-end relative cursor-pointer" style="border-bottom: 3px solid #f23e8e;">
      <p class="text-[#f23e8e] text-[20px] font-semibold leading-[1]">Buscar vacantes</p>
    </div>
    <div class="flex flex-col gap-[16px] items-center justify-end relative cursor-pointer" onclick="window.location.href='/ver-postulaciones'">
      <p class="text-[#606261] text-[20px] font-medium leading-[1.2]">Ver postulaciones</p>
      <div class="h-0 w-full"></div>
    </div>
    <div class="flex flex-col gap-[16px] items-center justify-end relative cursor-pointer" onclick="window.location.href='/home-postulantes'">
      <p class="text-[#606261] text-[20px] font-medium leading-[1.2]">Actividades</p>
      <div class="h-0 w-full"></div>
    </div>
    <!-- Pattern decorations -->
    <div class="absolute bottom-0 left-[78px] top-0 w-[127px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="pattern" class="absolute h-[239%] left-[-5%] top-[-71%] w-[106%]" onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 left-[197px] top-0 w-[85px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="pattern" class="absolute h-[239%] left-[-6%] top-[-71%] w-[158%]" onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 right-[129px] top-0 w-[58px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="pattern" class="absolute h-[239%] left-[-59%] top-[-71%] w-[231%]" onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 right-0 top-0 w-[127px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="pattern" class="absolute h-[239%] left-[-5%] top-[-71%] w-[106%]" onerror="this.style.display='none'" />
    </div>
  </nav>

  <!-- Search Bar -->
  <section class="w-full mx-auto mt-8 px-4">
    <div class="mx-auto w-[808px] h-20 flex items-center bg-white border border-neutral-80 rounded-[64px] px-8">
      <input id="searchInput" type="text" placeholder="Junior / Intern Position" class="flex-1 outline-none text-neutral-80 placeholder-neutral-80 text-[20px]" />
      <button id="searchBtn" class="bg-primary-tint10 rounded-full w-16 h-16 flex items-center justify-center hover:bg-primary-shade80/10" title="Buscar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-neutral-40">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18a7.5 7.5 0 006.15-3.35z" />
        </svg>
      </button>
    </div>
  </section>

  <!-- Main layout -->
  <main class="max-w-[1500px] mx-auto mt-10 px-4 flex gap-6">
    <!-- Vacantes List (fixed width like Figma) -->
    <aside class="w-[392px] space-y-4 overflow-y-auto max-h-[70vh] pr-1 no-scrollbar shrink-0" id="vacantesList">
      <!-- Job cards injected here -->
      <div id="loadingVacantes" class="text-sm text-neutral-60">Cargando vacantes...</div>
    </aside>

    <!-- Detalle Vacante -->
    <section class="flex-1 bg-primary-tint02 rounded-md p-12 border border-neutral-80/40" id="detalleVacante">
      <div id="detallePlaceholder" class="text-neutral-60">Selecciona una vacante para ver los detalles.</div>
    </section>
  </main>

  <!-- Templates (hidden) -->
  <template id="tplVacante">
    <div class="border border-neutral-70/40 rounded-md p-4 bg-white flex flex-col gap-3 shadow-sm hover:shadow-md transition group">
      <div class="flex items-start justify-between">
        <div class="flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-primary-shade60/20 flex items-center justify-center text-[10px] text-primary-shade60 font-semibold">C</div>
          <p class="text-sm text-neutral-60 font-medium company-name"></p>
        </div>
        <button class="bookmark text-neutral-40 hover:text-primary-shade60" title="Guardar">☆</button>
      </div>
      <h3 class="text-lg font-medium job-title"></h3>
      <p class="text-xs text-neutral-50 job-location"></p>
      <div class="flex flex-wrap gap-2">
        <span class="px-4 py-1 rounded-full border border-primary-shade60 text-primary-shade60 text-xs font-semibold ease-tag hidden">Easy Apply</span>
        <span class="px-4 py-1 rounded-full bg-primary-tint10 text-primary-shade60 text-xs font-semibold multi-tag hidden">Multiple Candidate</span>
        <span class="px-4 py-1 rounded-full bg-neutral-80/10 text-neutral-40 text-xs font-medium modality-tag"></span>
      </div>
      <div class="flex items-center justify-between text-xs text-neutral-40">
        <span class="published-ago"></span>
        <span class="applications-count"></span>
      </div>
    </div>
  </template>

  <script>
    async function fetchVacantes(query='') {
      const list = document.getElementById('vacantesList');
      list.innerHTML = ''; // reset
      const loading = document.createElement('div');
      loading.textContent = 'Cargando vacantes...';
      loading.className = 'text-sm text-neutral-60';
      list.appendChild(loading);
      try {
        const url = '/api/vacantes/publicadas' + (query ? ('?search=' + encodeURIComponent(query)) : '');
        console.log('Fetching vacantes from:', url);
        const res = await fetch(url);
        console.log('Response status:', res.status);
        
        if(!res.ok) {
          const errorData = await res.json().catch(() => ({detail: 'Error desconocido'}));
          console.error('Error response:', errorData);
          throw new Error(errorData.detail || 'Error al obtener vacantes');
        }
        
        const data = await res.json();
        console.log('Vacantes recibidas:', data);
        list.innerHTML='';
        
        if(!data.vacantes || !data.vacantes.length){
          list.innerHTML = '<div class="text-sm text-neutral-60 p-4"><p class="font-semibold mb-2">No se encontraron vacantes publicadas.</p><p class="text-xs">Las empresas deben crear vacantes con estado "Publicada" para que aparezcan aquí.</p></div>';
          return;
        }
        
        data.vacantes.forEach(v => renderVacanteCard(v));
        // Auto-select: prefer id from query param, otherwise first
        const params = new URLSearchParams(window.location.search);
        const selectedId = params.get('id');
        if (selectedId) {
          const found = data.vacantes.find(x => String(x.id_vacante) === String(selectedId) || String(x.id) === String(selectedId));
          if (found) {
            renderDetalle(found);
          } else {
            renderDetalle(data.vacantes[0]);
          }
        } else {
          renderDetalle(data.vacantes[0]);
        }
      } catch(e){
        console.error('Error fetching vacantes:', e);
        list.innerHTML = '<div class="text-sm text-red-600 p-4"><p class="font-semibold mb-2">❌ Error al cargar vacantes</p><p class="text-xs">' + e.message + '</p><p class="text-xs mt-2">Verifica: 1) Conexión a base de datos en .env, 2) Servidor corriendo, 3) Vacantes con estado "Publicada"</p></div>';
      }
    }

    function timeAgo(fechaISO){
      if(!fechaISO) return '';
      const diffMs = Date.now() - new Date(fechaISO).getTime();
      const days = Math.floor(diffMs/86400000);
      return days + 'd';
    }

    function renderVacanteCard(v){
      const tpl = document.getElementById('tplVacante').content.cloneNode(true);
      tpl.querySelector('.company-name').textContent = v.nombre_empresa;
      tpl.querySelector('.job-title').textContent = v.titulo;
      tpl.querySelector('.job-location').textContent = (v.modalidad || '') + (v.salario? ' • $' + v.salario : '');
      tpl.querySelector('.modality-tag').textContent = v.modalidad || '';
      tpl.querySelector('.published-ago').textContent = timeAgo(v.fecha_creacion);
      tpl.querySelector('.applications-count').textContent = v.num_postulaciones + ' postulaciones';
      const card = tpl.children[0];
      card.addEventListener('click',()=>renderDetalle(v));
      document.getElementById('vacantesList').appendChild(card);
    }

    function renderDetalle(v){
      const cont = document.getElementById('detalleVacante');
      cont.innerHTML = '';

      // Header block
      const header = document.createElement('div');
      header.className = 'flex justify-between items-start mb-6';
      header.innerHTML = `
        <div>
          <p class='text-link text-sm font-semibold'>${v.nombre_empresa || ''}</p>
          <h2 class='text-2xl font-semibold mt-2'>${v.titulo || ''}</h2>
          <p class='text-sm text-neutral-50 mt-1'>${v.modalidad || ''}</p>
        </div>
        <div class='flex flex-col gap-4 items-end'>
          <button id='applyBtn' class='bg-primary-100 text-primary-shade05 px-6 py-3 rounded-full font-semibold hover:bg-primary-shade80 transition'>Postular</button>
          <span class='text-xs text-neutral-50'>${v.num_postulaciones ?? 0} postulaciones</span>
        </div>`;
      cont.appendChild(header);

      // "tab" row (visual only, Job Description active)
      const tabs = document.createElement('div');
      tabs.className = 'flex items-center gap-10 border-b border-neutral-80/60 pb-3 mb-6';
      tabs.innerHTML = `
        <div class='flex flex-col'>
          <span class='text-neutral-20 font-semibold'>Job Description</span>
          <span class='h-0.5 w-32 bg-neutral-80 mt-2'></span>
        </div>
        <span class='text-neutral-70'>Requirement</span>
        <span class='text-neutral-70'>Benefit</span>
        <span class='text-neutral-70'>Overview</span>`;
      cont.appendChild(tabs);

      // Body sections (primarily Job Description populated)
      const body = document.createElement('div');
      body.className='space-y-8 text-sm font-inter';
      body.innerHTML = `
        <section>
          <h3 class='font-semibold text-neutral-20 text-base mb-3'>Job Description</h3>
          <p class='leading-7 text-neutral-10'>${(v.descripcion || 'Sin descripción disponible.')}</p>
        </section>
      `;
      cont.appendChild(body);

      const applyBtn = document.getElementById('applyBtn');
      if (applyBtn) applyBtn.addEventListener('click',()=>applyToVacante(v.id_vacante || v.id));
    }

    async function applyToVacante(id){
      const btn = document.getElementById('applyBtn');
      btn.disabled = true; btn.textContent='Enviando...';
      try {
        const res = await fetch(`/api/vacantes/${id}/postular`, {method:'POST'});
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail||'Error al postular');
        btn.textContent='Postulación enviada';
        btn.classList.remove('bg-primary-100');
        btn.classList.add('bg-green-500','text-white');
        // Refresh list to update counts
        fetchVacantes(document.getElementById('searchInput').value.trim());
      } catch(e){
        btn.disabled=false; btn.textContent='Postular';
        alert(e.message);
      }
    }

    document.getElementById('searchBtn').addEventListener('click',()=>{
      const q = document.getElementById('searchInput').value.trim();
      fetchVacantes(q);
    });
    document.getElementById('searchInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ fetchVacantes(e.target.value.trim()); }});
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{ try { await fetch('/api/logout',{method:'POST'}); location.href='/login'; } catch(e){} });
    document.getElementById('profileBtn')?.addEventListener('click', ()=>{ window.location.href='/editar-perfil'; });

    fetchVacantes();
  </script>
</body>
</html>