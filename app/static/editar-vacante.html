<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <base href="/">
  <title>Editar Vacante - Jobly</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/auth.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .option-btn.active {
      background-color: white;
      border-color: #e5eae8;
    }
    .option-btn.active::before {
      content: '✓';
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background-color: #f2ecfe;
      color: #c89bfa;
      border-radius: 9999px;
      font-size: 16px;
      margin-right: 4px;
    }
  </style>
</head>
<body class="bg-[#fbfcfb] min-h-screen font-[Poppins,sans-serif] overflow-x-hidden">
  <!-- Header -->
  <header class="flex items-center justify-between px-[32px] pl-[32px] pr-[108px] pt-[24px] pb-[16px] border-b border-[#e5eae8] h-[86px] bg-white">
    <a href="/home-empresa" class="block h-[62px] w-[172px]">
      <img src="/static/images/logo-login.png" alt="Jobly Logo" class="h-full w-full object-contain" 
           onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27172%27 height=%2762%27%3E%3Crect width=%27172%27 height=%2762%27 fill=%27%23f23e8e%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27white%27 font-family=%27Arial%27 font-size=%2720%27%3EJobly%3C/text%3E%3C/svg%3E'" />
    </a>
    <div class="flex-1"></div>
    <div class="flex items-center gap-6">
      <!-- Help Icon -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="#141514" stroke-width="1.5"/>
        <path d="M9.09 9C9.325 8.33 9.835 7.81 10.5 7.57C11.165 7.33 11.903 7.39 12.516 7.74C13.129 8.09 13.563 8.69 13.72 9.38C13.877 10.07 13.745 10.79 13.35 11.38C12.955 11.97 12.33 12.38 11.62 12.51V13.5" stroke="#141514" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="12" cy="17" r="1" fill="#141514"/>
      </svg>
      <!-- Mail Icon -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="#141514" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M22 6L12 13L2 6" stroke="#141514" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <!-- Profile Icon (Purple) -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" fill="#c89bfa"/>
        <circle cx="12" cy="10" r="3" fill="white"/>
        <path d="M6.168 18.849A6.5 6.5 0 0 1 12 15.5a6.5 6.5 0 0 1 5.832 3.349" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <!-- Logout Button -->
      <button id="logoutBtn" class="border border-[#141514] text-[#141514] px-3 py-1 rounded-[24px] text-sm font-semibold hover:bg-[#141514] hover:text-white transition-colors">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- Subheader Tabs -->
  <section class="flex gap-[64px] items-end justify-center px-[108px] pt-[16px] pb-0 border-b border-[#e5eae8] h-[56px] bg-white relative">
    <!-- Nueva Vacante (Active) -->
    <div class="flex flex-col gap-[14px] items-center justify-center max-w-[130px] cursor-pointer">
      <p class="text-[#c89bfa] text-[20px] font-semibold text-center leading-[1] whitespace-nowrap">Nueva Vacante</p>
      <div class="w-full h-[3px] bg-gradient-to-r from-transparent via-[#c89bfa] to-transparent"></div>
    </div>
    
    <!-- Ver Vacantes -->
    <div class="flex flex-col gap-[14px] items-center justify-center max-w-[130px] cursor-pointer" onclick="window.location.href='/ver-vacantes'">
      <p class="text-[#606261] text-[20px] font-medium text-center leading-[1.2] whitespace-nowrap">Ver Vacantes</p>
      <div class="w-full h-[3px] bg-transparent"></div>
    </div>
    
    <!-- Actividades -->
    <div class="flex flex-col gap-[14px] items-center justify-center max-w-[130px] cursor-pointer" onclick="window.location.href='/home-empresa'">
      <p class="text-[#606261] text-[20px] font-medium text-center leading-[1.2] whitespace-nowrap">Actividades</p>
      <div class="w-full h-[3px] bg-transparent"></div>
    </div>
    
    <!-- Pattern decorations -->
    <div class="absolute bottom-0 left-[78px] top-0 w-[127px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-5.51%] top-[-71.43%] w-[105.51%] object-cover" onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 left-[197px] top-0 w-[85px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-5.88%] top-[-71.43%] w-[157.65%] object-cover" onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 right-[129px] top-0 w-[58px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-58.62%] top-[-71.43%] w-[231.03%] object-cover" onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 right-0 top-0 w-[127px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-5.51%] top-[-71.43%] w-[105.51%] object-cover" onerror="this.style.display='none'" />
    </div>
  </section>

  <!-- Main Content -->
  <main class="max-w-[600px] mx-auto px-4 pt-12 pb-24">
    <!-- Progress Bar & Actions -->
    <div class="flex items-center justify-between mb-8">
      <button type="button" onclick="window.location.href='/ver-vacantes'" class="inline-flex items-center gap-2 text-[#141514]">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
          <path d="M15 18l-6-6 6-6" stroke="#141514" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="text-sm font-medium">Volver</span>
      </button>

      <div class="w-[260px] h-2 bg-[#f2ecfe] rounded-full overflow-hidden">
        <div class="h-full w-[70%] bg-[#b080e8]"></div>
      </div>

      <button type="button" onclick="window.location.href='/ver-vacantes'" class="text-[16px] font-semibold text-[#141514] tracking-[0.48px]">
        Save And Exit
      </button>
    </div>

    <!-- Title -->
    <h1 class="text-[32px] font-semibold text-[#141514] leading-[1.2] mb-8">Editar Vacante</h1>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-12">
      <p class="text-[#606261]">Cargando datos de la vacante...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden text-center py-12">
      <p class="text-red-600" id="errorMessage">Error cargando la vacante</p>
      <button onclick="window.location.href='/ver-vacantes'" class="mt-4 text-[#c89bfa] underline">Volver a vacantes</button>
    </div>

    <!-- Form (Hidden until data loads) -->
    <form id="editForm" class="space-y-10 hidden">
      <!-- Modalidad -->
      <div>
        <label class="block text-[16px] font-semibold text-[#141514] tracking-[0.48px] mb-3">Modalidad*</label>
        <div id="modalidadGroup" class="flex flex-wrap gap-4">
          <button type="button" class="option-btn px-4 py-2 border border-[#e5eae8] rounded-[64px] text-[14px] font-medium text-[#141514] capitalize leading-[1.7] flex items-center" data-value="Presencial">
            Presencial
          </button>
          <button type="button" class="option-btn px-4 py-2 border border-[#e5eae8] rounded-[64px] text-[14px] font-medium text-[#141514] capitalize leading-[1.7] flex items-center" data-value="Híbrido">
            Híbrido
          </button>
          <button type="button" class="option-btn px-4 py-2 border border-[#e5eae8] rounded-[64px] text-[14px] font-medium text-[#141514] capitalize leading-[1.7] flex items-center" data-value="Remoto">
            Remoto
          </button>
          <button type="button" class="option-btn px-4 py-2 border border-[#e5eae8] rounded-[64px] text-[14px] font-medium text-[#141514] capitalize leading-[1.7] flex items-center" data-value="Carretera">
            Carretera
          </button>
        </div>
      </div>

      <!-- Cambiar Estado -->
      <div>
        <label class="block text-[16px] font-semibold text-[#141514] tracking-[0.48px] mb-3">Cambiar Estado</label>
        <div id="estadoGroup" class="flex flex-wrap gap-4">
          <button type="button" class="option-btn px-4 py-2 border border-[#e5eae8] rounded-[64px] text-[14px] font-medium text-[#141514] capitalize leading-[1.7] flex items-center" data-value="Borrador">
            Borrador
          </button>
          <button type="button" class="option-btn px-4 py-2 border border-[#e5eae8] rounded-[64px] text-[14px] font-medium text-[#141514] capitalize leading-[1.7] flex items-center" data-value="Publicada">
            Publicada
          </button>
          <button type="button" class="option-btn px-4 py-2 border border-[#e5eae8] rounded-[64px] text-[14px] font-medium text-[#141514] capitalize leading-[1.7] flex items-center" data-value="Cerrada">
            Cerrada
          </button>
        </div>
      </div>

      <!-- Título -->
      <div>
        <label class="block text-[16px] font-semibold text-[#141514] tracking-[0.48px] mb-2">Título</label>
        <input 
          type="text" 
          name="titulo" 
          id="tituloInput"
          class="w-full border border-[#cfd4d1] rounded-[4px] p-4 h-[56px] text-[14px] font-medium text-[#141514] tracking-[0.28px] capitalize placeholder:text-[#b8bdbb]"
          placeholder="Título del puesto de trabajo"
          required
        />
      </div>

      <!-- Descripción -->
      <div>
        <label class="block text-[16px] font-semibold text-[#141514] tracking-[0.48px] mb-2">Descripción *</label>
        <textarea 
          name="descripcion" 
          id="descripcionInput"
          class="w-full border border-[#cfd4d1] rounded-[4px] p-4 h-[200px] text-[14px] font-medium text-[#141514] resize-none placeholder:text-[#b8bdbb]"
          placeholder="Descripción de la vacante..."
        ></textarea>
      </div>

      <!-- Salario -->
      <div>
        <label class="block text-[16px] font-semibold text-[#141514] tracking-[0.48px] mb-2">Cuál es el salario base?</label>
        <input 
          type="number" 
          name="salario" 
          id="salarioInput"
          step="0.01"
          class="w-full border border-[#cfd4d1] rounded-[4px] p-4 h-[56px] text-[14px] font-medium text-[#141514] tracking-[0.28px] capitalize placeholder:text-[#b8bdbb]"
          placeholder="Ej: 2500.00"
        />
      </div>

      <!-- Continue Button -->
      <div class="flex justify-start">
        <button 
          type="submit" 
          class="bg-[#c89bfa] text-white px-6 py-3 rounded-[64px] text-[16px] font-semibold leading-[1.2] hover:bg-[#b080e8] transition-colors"
        >
          Continue
        </button>
      </div>
    </form>
  </main>

  <script>
    let currentVacancyId = null;
    let selectedModalidad = null;
    let selectedEstado = null;

    // Get vacancy ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const vacancyId = urlParams.get('id');

    if (!vacancyId) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = 'ID de vacante no proporcionado';
    } else {
      currentVacancyId = parseInt(vacancyId);
      loadVacancyData();
    }

    async function loadVacancyData() {
      try {
        const response = await fetch(`/api/vacantes/${currentVacancyId}`);
        
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/login';
            return;
          }
          throw new Error('Error al cargar la vacante');
        }

        const vacancy = await response.json();
        
        // Populate form
        document.getElementById('tituloInput').value = vacancy.titulo || '';
        document.getElementById('descripcionInput').value = vacancy.descripcion || '';
        document.getElementById('salarioInput').value = vacancy.salario || '';
        
        // Set selected modalidad
        selectedModalidad = vacancy.modalidad;
        const modalidadBtns = document.querySelectorAll('#modalidadGroup .option-btn');
        modalidadBtns.forEach(btn => {
          if (btn.dataset.value === vacancy.modalidad) {
            btn.classList.add('active');
          }
        });
        
        // Set selected estado
        selectedEstado = vacancy.estado;
        const estadoBtns = document.querySelectorAll('#estadoGroup .option-btn');
        estadoBtns.forEach(btn => {
          if (btn.dataset.value === vacancy.estado) {
            btn.classList.add('active');
          }
        });
        
        // Hide loading, show form
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('editForm').classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading vacancy:', error);
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('errorState').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    // Modalidad button handlers
    document.querySelectorAll('#modalidadGroup .option-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('#modalidadGroup .option-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedModalidad = btn.dataset.value;
      });
    });

    // Estado button handlers
    document.querySelectorAll('#estadoGroup .option-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('#estadoGroup .option-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedEstado = btn.dataset.value;
      });
    });

    // Form submission
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!selectedModalidad) {
        alert('Selecciona la modalidad');
        return;
      }
      
      if (!selectedEstado) {
        alert('Selecciona el estado');
        return;
      }
      
      const titulo = document.getElementById('tituloInput').value.trim();
      if (!titulo) {
        alert('Ingresa un título');
        return;
      }
      
      const descripcion = document.getElementById('descripcionInput').value.trim();
      const salarioValue = document.getElementById('salarioInput').value.trim();
      const salario = salarioValue ? parseFloat(salarioValue) : null;
      
      const payload = {
        titulo,
        descripcion,
        salario,
        modalidad: selectedModalidad,
        estado: selectedEstado
      };
      
      try {
        const response = await fetch(`/api/vacantes/${currentVacancyId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.detail || 'Error actualizando la vacante');
        }
        
        // Success - redirect to ver-vacantes
        alert('Vacante actualizada exitosamente');
        window.location.href = '/ver-vacantes';
        
      } catch (error) {
        console.error('Error updating vacancy:', error);
        alert('No se pudo actualizar la vacante: ' + error.message);
      }
    });
  </script>
</body>
</html>
