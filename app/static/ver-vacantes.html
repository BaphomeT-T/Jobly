<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <base href="/">
  <title>Ver Vacantes - Jobly</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/auth.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>
<body class="bg-white min-h-screen font-[Poppins,sans-serif] overflow-x-hidden">
  <!-- Header -->
  <header class="flex items-center justify-between px-[32px] pl-[32px] pr-[108px] pt-[24px] pb-[16px] border-b border-[#e5eae8] h-[86px] bg-white">
    <a href="/home-empresa" class="block h-[62px] w-[172px]">
      <img src="/static/images/logo-login.png" alt="Jobly Logo" class="h-full w-full object-contain" 
           onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27172%27 height=%2762%27%3E%3Crect width=%27172%27 height=%2762%27 fill=%27%23f23e8e%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27white%27 font-family=%27Arial%27 font-size=%2720%27%3EJobly%3C/text%3E%3C/svg%3E'" />
    </a>
    <div class="flex-1"></div>
    <div class="flex items-center gap-6">
      <!-- Help Icon -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="#141514" stroke-width="1.5"/>
        <path d="M9.09 9C9.325 8.33 9.835 7.81 10.5 7.57C11.165 7.33 11.903 7.39 12.516 7.74C13.129 8.09 13.563 8.69 13.72 9.38C13.877 10.07 13.745 10.79 13.35 11.38C12.955 11.97 12.33 12.38 11.62 12.51V13.5" stroke="#141514" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="12" cy="17" r="1" fill="#141514"/>
      </svg>
      <!-- Mail Icon -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="#141514" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M22 6L12 13L2 6" stroke="#141514" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <!-- Profile Icon (Purple) -->
      <svg class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" fill="#c89bfa"/>
        <circle cx="12" cy="10" r="3" fill="white"/>
        <path d="M6.168 18.849A6.5 6.5 0 0 1 12 15.5a6.5 6.5 0 0 1 5.832 3.349" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <!-- Logout Button -->
      <button id="logoutBtn" class="border border-[#141514] text-[#141514] px-3 py-1 rounded-[24px] text-sm font-semibold hover:bg-[#141514] hover:text-white transition-colors">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- Subheader -->
  <section class="flex gap-[64px] items-end justify-center px-[108px] pt-[16px] pb-0 border-b border-[#e5eae8] h-[56px] bg-white relative">
    <!-- Tab 1: Nueva Vacante -->
    <div class="flex flex-col gap-[14px] items-center justify-center max-w-[130px] cursor-pointer tab-item" data-tab="nueva-vacante" onclick="window.location.href='/realizar-vacante'">
      <p class="text-[#606261] text-[20px] font-medium text-center leading-[1.2] whitespace-nowrap tab-text">Nueva Vacante</p>
      <div class="w-full h-[3px] bg-transparent tab-line"></div>
    </div>
    
    <!-- Tab 2: Ver Vacantes (Active) -->
    <div class="flex flex-col gap-[14px] items-center justify-center max-w-[130px] cursor-pointer tab-item active" data-tab="ver-vacantes">
      <p class="text-[#c89bfa] text-[20px] font-semibold text-center leading-[1] whitespace-nowrap tab-text">Ver Vacantes</p>
      <div class="w-full h-[3px] bg-gradient-to-r from-transparent via-[#c89bfa] to-transparent tab-line"></div>
    </div>
    
    <!-- Tab 3: Actividades -->
    <div class="flex flex-col gap-[14px] items-center justify-center max-w-[130px] cursor-pointer tab-item" data-tab="actividades" onclick="window.location.href='/home-empresa'">
      <p class="text-[#606261] text-[20px] font-medium text-center leading-[1.2] whitespace-nowrap tab-text">Actividades</p>
      <div class="w-full h-[3px] bg-transparent tab-line"></div>
    </div>
    
    <!-- Pattern decorations -->
    <div class="absolute bottom-0 left-[78px] top-0 w-[127px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-5.51%] top-[-71.43%] w-[105.51%] object-cover" 
           onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 left-[197px] top-0 w-[85px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-5.88%] top-[-71.43%] w-[157.65%] object-cover" 
           onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 right-[129px] top-0 w-[58px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-58.62%] top-[-71.43%] w-[231.03%] object-cover" 
           onerror="this.style.display='none'" />
    </div>
    <div class="absolute bottom-0 right-0 top-0 w-[127px] opacity-10 pointer-events-none overflow-hidden">
      <img src="/static/images/pattern-login.png" alt="Pattern" class="absolute h-[239.29%] left-[-5.51%] top-[-71.43%] w-[105.51%] object-cover" 
           onerror="this.style.display='none'" />
    </div>
  </section>

  <!-- Main Content -->
  <main class="px-[108px] pt-[80px] pb-[100px]">
    <!-- Título -->
    <h1 class="text-[40px] font-semibold text-black leading-[1.2] mb-[64px]">Vacantes</h1>

    <!-- Search Bar -->
    <div class="border border-[#b8bdbb] rounded-[50px] px-[24px] py-[24px] flex items-center justify-between mb-[42px] max-w-[599px]">
      <div class="flex items-center gap-[24px]">
        <!-- Search Icon -->
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="7" stroke="#141514" stroke-width="1.5"/>
          <path d="M20 20L17 17" stroke="#141514" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <input 
          type="text" 
          id="searchInput"
          placeholder="Search and Filter" 
          class="text-[18px] font-medium text-[#a2a6a4] outline-none border-none bg-transparent flex-1"
        />
      </div>
      <!-- Filter Icon (add id for JS hook, no visual change) -->
      <svg id="filterIcon" class="w-6 h-6 cursor-pointer" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 7h6M13 7h8M3 12h2M9 12h12M3 17h12M19 17h2" stroke="#141514" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="9.5" cy="7" r="2.5" fill="white" stroke="#141514" stroke-width="1.5"/>
        <circle cx="6.5" cy="12" r="2.5" fill="white" stroke="#141514" stroke-width="1.5"/>
        <circle cx="16.5" cy="17" r="2.5" fill="white" stroke="#141514" stroke-width="1.5"/>
      </svg>
    </div>

    <!-- Table Header -->
    <div class="bg-white px-[24px] py-[16px] flex items-center gap-[32px] h-[64px] mb-0">
      <div class="flex items-center gap-[100px] flex-1">
        <p class="capitalize text-[#b080e8] text-[16px] font-semibold leading-[1.2] w-[220px]">Título</p>
        <p class="capitalize text-[#b080e8] text-[16px] font-semibold leading-[1.2] tracking-[0.48px] w-[150px]">Modalidad</p>
        <p class="capitalize text-[#b080e8] text-[16px] font-semibold leading-[1.2] tracking-[0.48px] w-[109px]">Aplicantes</p>
        <p class="capitalize text-[#b080e8] text-[16px] font-semibold leading-[1.2] tracking-[0.48px] w-[150px]">Fecha</p>
        <p class="capitalize text-[#b080e8] text-[16px] font-semibold leading-[1.2] tracking-[0.48px] w-[70px]">Estado</p>
      </div>
      <!-- More icon -->
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="6" r="1.5" fill="#141514"/>
        <circle cx="12" cy="12" r="1.5" fill="#141514"/>
        <circle cx="12" cy="18" r="1.5" fill="#141514"/>
      </svg>
    </div>

    <!-- Table Body (Dynamic) -->
    <div id="vacantesTableBody">
      <!-- Loading state -->
      <div class="text-center py-12 text-[#606261]" id="loadingState">
        <p>Cargando vacantes...</p>
      </div>
      <!-- Empty state -->
      <div class="text-center py-12 text-[#606261] hidden" id="emptyState">
        <p>No hay vacantes publicadas</p>
      </div>
    </div>
  </main>

  <!-- Filters modal (hidden by default) -->
  <div id="filterModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-lg p-6 w-[720px] max-w-[95%]">
      <h2 class="text-lg font-semibold mb-4">Filtros de Vacantes</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Fecha desde</label>
          <input id="dateFrom" type="date" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Fecha hasta</label>
          <input id="dateTo" type="date" class="w-full p-2 border rounded" />
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium mb-2">Estado</label>
          <div class="flex gap-4">
            <label><input type="checkbox" class="estadoChk" value="Borrador" /> Borrador</label>
            <label><input type="checkbox" class="estadoChk" value="Publicada" /> Publicada</label>
            <label><input type="checkbox" class="estadoChk" value="Cerrada" /> Cerrada</label>
          </div>
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium mb-2">Modalidad</label>
          <div class="flex gap-4 flex-wrap">
            <label><input type="checkbox" class="modalidadChk" value="Presencial" /> Presencial</label>
            <label><input type="checkbox" class="modalidadChk" value="Remoto" /> Remoto</label>
            <label><input type="checkbox" class="modalidadChk" value="Híbrido" /> Híbrido</label>
            <label><input type="checkbox" class="modalidadChk" value="Virtual" /> Virtual</label>
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button id="clearFilters" class="px-4 py-2 border rounded">Limpiar</button>
        <button id="applyFilters" class="px-4 py-2 bg-[#f23e8e] text-white rounded">Aplicar</button>
        <button id="closeFilters" class="px-4 py-2 border rounded">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="border-t border-[#e5eae8] px-[108px] py-[24px] flex flex-col gap-[48px] items-center h-[235px] bg-white">
    <div class="flex gap-[32px] items-end w-[1368px]">
      <div class="flex-1"></div>
      <div class="flex flex-col gap-[16px] items-end w-[156px]">
        <img src="/static/images/logo-login.png" alt="Jobly Logo" class="h-[67px] w-[186px] object-cover" 
             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27186%27 height=%2767%27%3E%3Crect width=%27186%27 height=%2767%27 fill=%27%23f23e8e%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27white%27 font-family=%27Arial%27 font-size=%2724%27%3EJobly%3C/text%3E%3C/svg%3E'" />
      </div>
    </div>
    <div class="flex items-center justify-center w-full relative">
      <div class="flex items-center justify-center">
        <p class="capitalize text-[12px] font-medium leading-[1.2] text-[rgba(0,0,0,0.5)]">Jobly Copyright</p>
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="9" stroke="rgba(0,0,0,0.5)" stroke-width="1.5"/>
          <path d="M14.5 9.5C14.5 8.5 13.5 7.5 12 7.5C10.5 7.5 9.5 8.5 9.5 9.5C9.5 10.5 10.5 11 12 11C13.5 11 14.5 11.5 14.5 12.5C14.5 13.5 13.5 14.5 12 14.5C10.5 14.5 9.5 13.5 9.5 12.5" stroke="rgba(0,0,0,0.5)" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <p class="capitalize text-[12px] font-medium leading-[1.2] text-[rgba(0,0,0,0.5)]">2025</p>
      </div>
    </div>
  </footer>

  <script>
    
    // Función para formatear fecha
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const month = months[date.getMonth()];
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Función para mapear estado a texto de UI
    function mapEstado(estado) {
      const estadoMap = {
        'Publicada': 'Public',
        'Cerrada': 'Closed',
        'Borrador': 'Draft',
        'Pausada': 'Paused'
      };
      return estadoMap[estado] || estado;
    }

    // Función para crear una fila de vacante
    function createVacanteRow(vacante, index) {
      const bgClass = index % 2 === 0 ? 'bg-[#f7f9f8]' : 'bg-white';
      const borderClass = index === 0 ? 'border border-[#a2a6a4]' : '';
      
      return `
        <div class="${bgClass} ${borderClass} px-[24px] py-[16px] rounded-[4px] flex items-center gap-[32px] h-[62px]">
          <!-- Star Icon -->
          <svg class="w-6 h-6 shrink-0" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="#b080e8"/>
          </svg>
          
          <!-- Content -->
          <div class="flex items-center justify-between flex-1 h-[30px]">
            <p class="text-[#1d1e1d] text-[16px] font-semibold leading-[1.2] w-[220px] truncate">${vacante.titulo}</p>
            <p class="capitalize text-[#333434] text-[16px] font-medium leading-[1.2] w-[150px]">${vacante.modalidad || 'N/A'}</p>
            
            <div class="flex items-center w-[150px]">
              <p class="text-[#333434] text-[16px] font-medium leading-[1.9] w-[40px]">${vacante.num_postulaciones}</p>
              <button class="border border-[#4a4b4a] px-[8px] py-[4px] rounded-[64px] ml-2">
                <p class="text-[#4a4b4a] text-[14px] font-semibold leading-[1.2]">View</p>
              </button>
            </div>
            
            <p class="text-[#333434] text-[14px] font-medium leading-[1.9] w-[170px]">${formatDate(vacante.fecha_creacion)}</p>
            <p class="text-[#333434] text-[16px] font-medium leading-[1.9] w-[70px]">${mapEstado(vacante.estado)}</p>
          </div>
          
          <!-- More Icon with Edit Link -->
          <svg class="w-6 h-6 shrink-0 cursor-pointer hover:opacity-70 transition-opacity" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="window.location.href='/editar-vacante?id=${vacante.id_vacante}'">
            <circle cx="12" cy="6" r="1.5" fill="#333434"/>
            <circle cx="12" cy="12" r="1.5" fill="#333434"/>
            <circle cx="12" cy="18" r="1.5" fill="#333434"/>
          </svg>
        </div>
      `;
    }

    // Cargar vacantes
    async function loadVacantes() {
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const tableBody = document.getElementById('vacantesTableBody');
      
      try {
        const response = await fetch('/api/vacantes/empresa');
        
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/login';
            return;
          }
          throw new Error('Error al cargar vacantes');
        }

        const data = await response.json();
        const vacantes = data.vacantes || [];

        loadingState.classList.add('hidden');

        if (vacantes.length === 0) {
          emptyState.classList.remove('hidden');
        } else {
          emptyState.classList.add('hidden');
          tableBody.innerHTML = vacantes.map((v, i) => createVacanteRow(v, i)).join('');
        }
      } catch (error) {
        console.error('Error cargando vacantes:', error);
        loadingState.innerHTML = '<p class="text-red-600">Error al cargar las vacantes. Por favor intenta nuevamente.</p>';
      }
    }

    // Búsqueda en tiempo real
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#vacantesTableBody > div');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? 'flex' : 'none';
      });
    });

    // Filtering logic for ver-vacantes
    (function(){
      const filterIcon = document.getElementById('filterIcon');
      const filterModal = document.getElementById('filterModal');
      const closeFilters = document.getElementById('closeFilters');
      const applyFilters = document.getElementById('applyFilters');
      const clearFilters = document.getElementById('clearFilters');
      const dateFromEl = document.getElementById('dateFrom');
      const dateToEl = document.getElementById('dateTo');
      let allVacantes = []; // cached

      function openModal(){ if(!filterModal) return; filterModal.classList.remove('hidden'); filterModal.classList.add('flex'); }
      function closeModal(){ if(!filterModal) return; filterModal.classList.add('hidden'); filterModal.classList.remove('flex'); }

      filterIcon?.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
      closeFilters?.addEventListener('click', closeModal);

      clearFilters?.addEventListener('click', () => {
        dateFromEl.value = ''; dateToEl.value = '';
        document.querySelectorAll('.estadoChk').forEach(c=>c.checked=false);
        document.querySelectorAll('.modalidadChk').forEach(c=>c.checked=false);
        renderVacantes(allVacantes);
      });

      applyFilters?.addEventListener('click', () => {
        const from = dateFromEl.value;
        const to = dateToEl.value;
        const estados = Array.from(document.querySelectorAll('.estadoChk:checked')).map(i=>i.value);
        const modalidades = Array.from(document.querySelectorAll('.modalidadChk:checked')).map(i=>i.value);

        const filtered = allVacantes.filter(v => {
          if (from) {
            const fv = v.fecha_creacion ? new Date(v.fecha_creacion) : null;
            if (!fv || fv < new Date(from + 'T00:00:00')) return false;
          }
          if (to) {
            const fv = v.fecha_creacion ? new Date(v.fecha_creacion) : null;
            if (!fv || fv > new Date(to + 'T23:59:59')) return false;
          }
          if (estados.length && !estados.includes(v.estado)) return false;
          if (modalidades.length) {
            const m = (v.modalidad || '').toLowerCase();
            const ok = modalidades.some(sel => m.includes(sel.toLowerCase()));
            if (!ok) return false;
          }
          return true;
        });

        renderVacantes(filtered);
        closeModal();
      });

      // expose helper to set allVacantes after load
      window.__setAllVacantes = function(arr){ allVacantes = Array.isArray(arr)?arr:[]; };
    })();

    // Cargar vacantes al cargar la página
    document.addEventListener('DOMContentLoaded', loadVacantes);
  </script>
</body>
</html>
